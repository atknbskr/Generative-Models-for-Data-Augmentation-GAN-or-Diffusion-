import torch
from torch.utils.data import Dataset
import numpy as np


class SyntheticDataset(Dataset):
    """Dataset of synthetic images generated by GAN"""
    
    def __init__(self, generator, minority_classes, samples_per_class, latent_dim, device, transform=None):
        """
        Args:
            generator: Trained generator model
            minority_classes: List of class indices to generate
            samples_per_class: Number of samples to generate per class
            latent_dim: Dimension of latent space
            device: Device to use for generation
            transform: Optional transform to apply
        """
        self.generator = generator
        self.minority_classes = minority_classes
        self.samples_per_class = samples_per_class
        self.latent_dim = latent_dim
        self.device = device
        self.transform = transform
        
        # Pre-generate all synthetic images
        self.images = []
        self.labels = []
        
        self.generator.eval()
        with torch.no_grad():
            for class_idx in minority_classes:
                # Generate in batches to avoid memory issues
                batch_size = 100
                num_batches = (samples_per_class + batch_size - 1) // batch_size
                
                for batch_idx in range(num_batches):
                    current_batch_size = min(batch_size, samples_per_class - batch_idx * batch_size)
                    
                    # Sample noise
                    z = torch.randn(current_batch_size, latent_dim).to(device)
                    labels = torch.full((current_batch_size,), class_idx, dtype=torch.long).to(device)
                    
                    # Generate images
                    gen_imgs = generator(z, labels)
                    
                    # Move to CPU and store
                    gen_imgs = gen_imgs.cpu()
                    for img in gen_imgs:
                        self.images.append(img)
                        self.labels.append(class_idx)
        
        print(f"Generated {len(self.images)} synthetic images for classes {minority_classes}")
    
    def __len__(self):
        return len(self.images)
    
    def __getitem__(self, idx):
        img = self.images[idx]
        label = self.labels[idx]
        
        # Apply transform if provided
        if self.transform:
            # Convert to PIL Image for transforms
            img = img * 0.5 + 0.5  # Denormalize
            img = torch.clamp(img, 0, 1)
            img = transforms.ToPILImage()(img)
            img = self.transform(img)
        
        return img, label


# Import at the end to avoid circular import
from torchvision import transforms
